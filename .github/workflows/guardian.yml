name: Ultimate Guardian - No Manual Needed

on:
  push:
    branches: [ main ] # 監控 Figma Push 到 main 的動作
  workflow_dispatch: # 加入這一行，讓你可以手動測試 

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  auto-repair-and-deploy:
    runs-on: ubuntu-latest
    steps:
# 1. 直接下載 main 分支 (這是 Figma Push 的對象)
      - name: Checkout Main Branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
# 2. 從 automation 分支強行抓取 .github 資料夾回來
      - name: Restore Configs from Automation
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          
          # 從遠端的 automation 分支提取 .github 目錄
          git fetch origin automation
          git checkout origin/automation -- .github/
          
          # 自動修正 vite.config.ts 的 base 路徑
          sed -i "s|base:.*|base: '/Senlogic/',|g" vite.config.ts || true
          
          # 將修復後的檔案推回 main 分支
          git add .github/ vite.config.ts
          git commit -m "Guardian: Auto-repair configs" || echo "No changes"
          git push origin main
# 3. 在當前目錄直接 Build (不再需要 cd main_repo)
      - name: Install and Build
        run: |
          npm install
          npm run build

      # 4. 上傳產出物 (請確認 Vite 產出資料夾名稱，通常是 dist)
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist # 如果報錯找不到 dist，試著改成 ./build
  deploy:
    runs-on: ubuntu-latest
    needs: auto-repair-and-deploy
    steps:
      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4
